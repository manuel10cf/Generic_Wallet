<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for blocktrail-sdk-nodejs/lib/encryption.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">blocktrail-sdk-nodejs/lib/</a> encryption.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">22.92% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>11/48</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/2</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/5</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">25% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>11/44</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var assert = require('assert');
var sjcl = require('sjcl');
var KeyDerivation = require('./keyderivation');
var randomBytes = require('randombytes');
&nbsp;
var Encryption = {
    defaultSaltLen: 10, /* can permit changes, no more than 512 bit (128 bytes) */
    tagLenBits: 128, /* can permit changes */
    ivLenBits: 128,  /* fixed */
    ivLenWords: 128 / 32
};
&nbsp;
Encryption.generateSalt = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >    return randomBytes(this.defaultSaltLen);</span>
};
&nbsp;
Encryption.generateIV = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >    return randomBytes(this.ivLenBits / 8);</span>
};
&nbsp;
Encryption.encrypt = <span class="fstat-no" title="function not covered" >function(pt, pw, iterations) {</span>
<span class="cstat-no" title="statement not covered" >    var salt = this.generateSalt();</span>
<span class="cstat-no" title="statement not covered" >    var iv = this.generateIV();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    iterations = typeof iterations === 'undefined' ? KeyDerivation.defaultIterations : iterations;</span>
<span class="cstat-no" title="statement not covered" >    return this.encryptWithSaltAndIV(pt, pw, salt, iv, iterations);</span>
};
&nbsp;
Encryption.encryptWithSaltAndIV = <span class="fstat-no" title="function not covered" >function(pt, pw, saltBuf, iv, iterations) {</span>
<span class="cstat-no" title="statement not covered" >    assert(pt instanceof Buffer, 'pt must be provided as a buffer');</span>
<span class="cstat-no" title="statement not covered" >    assert(pw instanceof Buffer, 'pw must be provided as a buffer');</span>
<span class="cstat-no" title="statement not covered" >    assert(iv instanceof Buffer, 'IV must be provided as a buffer');</span>
<span class="cstat-no" title="statement not covered" >    assert(saltBuf instanceof Buffer, 'saltBuff must be provided as a buffer');</span>
<span class="cstat-no" title="statement not covered" >    assert(iv.length === 16, 'IV must be exactly 16 bytes');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var SL = (new Buffer(1));</span>
<span class="cstat-no" title="statement not covered" >    var S = saltBuf;</span>
<span class="cstat-no" title="statement not covered" >    var I = new Buffer(4);</span>
<span class="cstat-no" title="statement not covered" >    SL.writeUInt8(saltBuf.length);</span>
<span class="cstat-no" title="statement not covered" >    I.writeUInt32LE(iterations);</span>
<span class="cstat-no" title="statement not covered" >    var header = SL.toString('hex') + S.toString('hex') + I.toString('hex');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var key = sjcl.codec.hex.toBits(KeyDerivation.compute(pw, saltBuf, iterations).toString('hex'));</span>
<span class="cstat-no" title="statement not covered" >    var ct_t = sjcl.mode.gcm.encrypt(</span>
      new sjcl.cipher.aes(key),
      sjcl.codec.hex.toBits(pt.toString('hex')),
      sjcl.codec.hex.toBits(iv.toString('hex')),
      sjcl.codec.hex.toBits(header),
      this.tagLenBits
    );
&nbsp;
    // iter || saltLen8 || salt || iv || tag || ct
<span class="cstat-no" title="statement not covered" >    return new Buffer([header, iv.toString('hex'), sjcl.codec.hex.fromBits(ct_t)].join(''), 'hex');</span>
};
&nbsp;
Encryption.decrypt = <span class="fstat-no" title="function not covered" >function(ct, pw) {</span>
<span class="cstat-no" title="statement not covered" >    assert(ct instanceof Buffer, 'cipherText must be provided as a Buffer');</span>
<span class="cstat-no" title="statement not covered" >    assert(pw instanceof Buffer, 'password must be provided as a Buffer');</span>
<span class="cstat-no" title="statement not covered" >    var copy = new Buffer(ct, 'hex');</span>
<span class="cstat-no" title="statement not covered" >    var c = 0;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var saltLen = copy.readUInt8(c)      ; <span class="cstat-no" title="statement not covered" ></span>c += 1;</span>
<span class="cstat-no" title="statement not covered" >    var salt = copy.slice(1, c + saltLen); <span class="cstat-no" title="statement not covered" ></span>c += saltLen;</span>
<span class="cstat-no" title="statement not covered" >    var iterations = copy.readUInt32LE(c); <span class="cstat-no" title="statement not covered" ></span>c += 4;</span>
<span class="cstat-no" title="statement not covered" >    var header = copy.slice(0, c);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var iv = copy.slice(c, 16 + c); <span class="cstat-no" title="statement not covered" ></span>c += 16;</span>
<span class="cstat-no" title="statement not covered" >    var ct_t = copy.slice(c);</span>
&nbsp;
    // SaltBuf is required for KeyDerivation. Convert to sjcl where required.
<span class="cstat-no" title="statement not covered" >    var key = KeyDerivation.compute(pw, salt, iterations);</span>
<span class="cstat-no" title="statement not covered" >    var plainText = sjcl.mode.gcm.decrypt(</span>
      new sjcl.cipher.aes(sjcl.codec.hex.toBits(key.toString('hex'))),
      sjcl.codec.hex.toBits(ct_t.toString('hex')),
      sjcl.codec.hex.toBits(iv.toString('hex')),
      sjcl.codec.hex.toBits(header.toString('hex')),
      this.tagLenBits
    );
<span class="cstat-no" title="statement not covered" >    return new Buffer(sjcl.codec.hex.fromBits(plainText), 'hex');</span>
};
&nbsp;
module.exports = Encryption;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Sep 20 2017 16:24:04 GMT+0200 (CEST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
